// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users and Authentication
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  username      String    @unique
  passwordHash  String    @map("password_hash")
  firstName     String?   @map("first_name")
  lastName      String?   @map("last_name")
  avatarUrl     String?   @map("avatar_url")
  
  // Email verification
  emailVerified   Boolean   @default(false) @map("email_verified")
  emailVerifiedAt DateTime? @map("email_verified_at")
  
  // Role and permissions
  roleId        String    @map("role_id")
  role          Role      @relation(fields: [roleId], references: [id])
  
  // MFA
  mfaEnabled    Boolean   @default(false) @map("mfa_enabled")
  mfaSecret     String?   @map("mfa_secret") // encrypted
  mfaBackupCodes String[] @map("mfa_backup_codes") // encrypted array
  
  // Security
  isActive      Boolean   @default(true) @map("is_active")
  isLocked      Boolean   @default(false) @map("is_locked")
  lockoutUntil  DateTime? @map("lockout_until")
  failedLoginAttempts Int @default(0) @map("failed_login_attempts")
  lastLoginAt   DateTime? @map("last_login_at")
  lastLoginIp   String?   @map("last_login_ip")
  passwordChangedAt DateTime @default(now()) @map("password_changed_at")
  mustChangePassword Boolean @default(false) @map("must_change_password")
  passwordHistory String[] @map("password_history") // hashed passwords
  
  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  // Relations
  sessions      UserSession[]
  auditEvents   AuditEvent[]
  purgeAudits   PurgeAudit[]
  passwordResets PasswordReset[]
  emailVerifications EmailVerification[]

  @@map("users")
}

model UserSession {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  accessTokenHash String @unique @map("access_token_hash")
  refreshTokenHash String @unique @map("refresh_token_hash")
  ipAddress    String   @map("ip_address")
  userAgent    String   @map("user_agent")
  deviceFingerprint String? @map("device_fingerprint")
  expiresAt    DateTime @map("expires_at")
  lastActivityAt DateTime @default(now()) @map("last_activity_at")
  createdAt    DateTime @default(now()) @map("created_at")
  revokedAt    DateTime? @map("revoked_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

// Role-Based Access Control
model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  displayName String   @map("display_name")
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  users       User[]
  permissions Permission[]

  @@map("roles")
}

model Permission {
  id       String @id @default(uuid())
  roleId   String @map("role_id")
  resource String
  action   String

  // Relations
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, resource, action])
  @@map("permissions")
}

// Password Reset
model PasswordReset {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tokenHash String   @unique @map("token_hash")
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

// Email Verification
model EmailVerification {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  tokenHash String   @unique @map("token_hash")
  expiresAt DateTime @map("expires_at")
  attempts  Int      @default(0)
  verifiedAt DateTime? @map("verified_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_verifications")
}

// SMTP Configuration
model SmtpConfig {
  id       String  @id @default(uuid())
  host     String
  port     Int
  username String
  password String  // encrypted
  fromAddress String @map("from_address")
  fromName String  @map("from_name")
  useTls   Boolean @default(true) @map("use_tls")
  isActive Boolean @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("smtp_config")
}

// Server Management
model Server {
  id                   String            @id @default(uuid())
  name                 String
  hostname             String
  port                 Int               @default(22)
  username             String
  authType             AuthType          @map("auth_type")
  encryptedCredentials String            @map("encrypted_credentials")
  hostKeyFingerprint   String?           @map("host_key_fingerprint")
  controlPanel         ControlPanelType? @map("control_panel")
  osInfo               Json?             @map("os_info")
  createdAt            DateTime          @default(now()) @map("created_at")
  updatedAt            DateTime          @updatedAt @map("updated_at")

  // Relations
  sites            Site[]
  commandExecutions CommandExecution[]

  @@map("servers")
}

// Site Management
model Site {
  id              String    @id @default(uuid())
  serverId        String    @map("server_id")
  domain          String
  documentRoot    String    @map("document_root")
  wordpressPath   String    @map("wordpress_path")
  isMultisite     Boolean   @default(false) @map("is_multisite")
  siteUrl         String    @map("site_url")
  adminUrl        String    @map("admin_url")
  isActive        Boolean   @default(true) @map("is_active")
  lastHealthCheck DateTime? @map("last_health_check")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  server    Server     @relation(fields: [serverId], references: [id], onDelete: Cascade)
  incidents Incident[]

  @@map("sites")
}

// Incident Management
model Incident {
  id                String        @id @default(uuid())
  siteId            String        @map("site_id")
  state             IncidentState
  triggerType       TriggerType   @map("trigger_type")
  priority          Priority
  fixAttempts       Int           @default(0) @map("fix_attempts")
  maxFixAttempts    Int           @default(15) @map("max_fix_attempts")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  resolvedAt        DateTime?     @map("resolved_at")
  escalatedAt       DateTime?     @map("escalated_at")
  escalationReason  String?       @map("escalation_reason")

  // Relations
  site              Site               @relation(fields: [siteId], references: [id], onDelete: Cascade)
  events            IncidentEvent[]
  commandExecutions CommandExecution[]
  evidence          Evidence[]
  backupArtifacts   BackupArtifact[]
  fileChanges       FileChange[]
  verificationResults VerificationResult[]

  @@map("incidents")
}

// Incident Timeline (Append-Only)
model IncidentEvent {
  id         String        @id @default(uuid())
  incidentId String        @map("incident_id")
  eventType  String        @map("event_type")
  phase      IncidentState
  step       String
  data       Json?
  timestamp  DateTime      @default(now())
  duration   Int?          // milliseconds

  // Relations
  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@map("incident_events")
}

// Command Execution Logs
model CommandExecution {
  id            String   @id @default(uuid())
  incidentId    String   @map("incident_id")
  command       String
  stdout        String?
  stderr        String?
  exitCode      Int?     @map("exit_code")
  executionTime Int?     @map("execution_time") // milliseconds
  timestamp     DateTime @default(now())
  serverId      String   @map("server_id")

  // Relations
  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  server   Server   @relation(fields: [serverId], references: [id])

  @@map("command_executions")
}

// Evidence Collection
model Evidence {
  id           String   @id @default(uuid())
  incidentId   String   @map("incident_id")
  evidenceType String   @map("evidence_type")
  signature    String
  content      String
  metadata     Json?
  timestamp    DateTime @default(now())

  // Relations
  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@map("evidence")
}

// Backup Artifacts
model BackupArtifact {
  id           String   @id @default(uuid())
  incidentId   String   @map("incident_id")
  artifactType String   @map("artifact_type")
  filePath     String   @map("file_path")
  originalPath String   @map("original_path")
  checksum     String
  size         BigInt
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@map("backup_artifacts")
}

// File Changes and Diffs
model FileChange {
  id              String   @id @default(uuid())
  incidentId      String   @map("incident_id")
  filePath        String   @map("file_path")
  changeType      String   @map("change_type")
  originalContent String?  @map("original_content")
  newContent      String?  @map("new_content")
  diff            String
  checksum        String
  timestamp       DateTime @default(now())

  // Relations
  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@map("file_changes")
}

// Verification Results
model VerificationResult {
  id               String   @id @default(uuid())
  incidentId       String   @map("incident_id")
  verificationType String   @map("verification_type")
  status           String
  details          Json?
  timestamp        DateTime @default(now())

  // Relations
  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@map("verification_results")
}

// Audit Trail
model AuditEvent {
  id           String    @id @default(uuid())
  userId       String?   @map("user_id")
  actorType    ActorType @default(USER) @map("actor_type")
  actorId      String?   @map("actor_id")
  action       String
  resource     String
  resourceId   String?   @map("resource_id")
  description  String
  metadata     Json?
  ipAddress    String?   @map("ip_address")
  userAgent    String?   @map("user_agent")
  severity     AuditSeverity @default(INFO)
  timestamp    DateTime  @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@map("audit_events")
}

// Retention Policy Configuration
model RetentionPolicy {
  id            String   @id @default(uuid())
  policyName    String   @unique @map("policy_name")
  retentionDays Int      @map("retention_days")
  appliesTo     String   @map("applies_to")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  purgeAudits PurgeAudit[]

  @@map("retention_policies")
}

// Purge Audit Trail
model PurgeAudit {
  id             String          @id @default(uuid())
  policyId       String          @map("policy_id")
  tableName      String          @map("table_name")
  recordsPurged  Int             @map("records_purged")
  cutoffDate     DateTime        @map("cutoff_date")
  executedAt     DateTime        @default(now()) @map("executed_at")
  executedBy     String          @map("executed_by")

  // Relations
  policy RetentionPolicy @relation(fields: [policyId], references: [id])
  user   User             @relation(fields: [executedBy], references: [id])

  @@map("purge_audit")
}

// Integration Management
model Integration {
  id                   String    @id @default(uuid())
  name                 String
  type                 IntegrationType
  enabled              Boolean   @default(true)
  configuration        Json      @default("{}")
  notificationSettings Json      @default("{}")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  // Relations
  webhookEndpoints WebhookEndpoint[]
  apiKeys          ApiKey[]
  webhookDeliveries WebhookDelivery[]

  @@map("integrations")
}

model WebhookEndpoint {
  id              String    @id @default(uuid())
  integrationId   String    @map("integration_id")
  url             String
  method          String    @default("POST")
  headers         Json      @default("{}")
  events          String[]
  retryPolicy     Json      @default("{}")
  isActive        Boolean   @default(true) @map("is_active")
  successCount    Int       @default(0) @map("success_count")
  failureCount    Int       @default(0) @map("failure_count")
  lastTriggeredAt DateTime? @map("last_triggered_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  integration       Integration       @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  webhookDeliveries WebhookDelivery[]

  @@map("webhook_endpoints")
}

model ApiKey {
  id            String    @id @default(uuid())
  integrationId String?   @map("integration_id")
  name          String
  keyHash       String    @unique @map("key_hash")
  permissions   String[]
  expiresAt     DateTime? @map("expires_at")
  lastUsedAt    DateTime? @map("last_used_at")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  integration Integration? @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

model WebhookDelivery {
  id            String    @id @default(uuid())
  integrationId String    @map("integration_id")
  endpointId    String    @map("endpoint_id")
  event         String
  payload       Json
  status        WebhookDeliveryStatus
  attempts      Int       @default(0)
  lastAttemptAt DateTime? @map("last_attempt_at")
  nextRetryAt   DateTime? @map("next_retry_at")
  response      Json?
  error         String?
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relations
  integration Integration     @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  endpoint    WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  @@map("webhook_deliveries")
}

// Enums
enum ActorType {
  USER
  SYSTEM
  API
}

enum AuditSeverity {
  INFO
  WARNING
  HIGH
  CRITICAL
}

enum AuthType {
  KEY
  PASSWORD
}

enum ControlPanelType {
  CPANEL
  PLESK
  DIRECTADMIN
  CYBERPANEL
}

enum IncidentState {
  NEW
  DISCOVERY
  BASELINE
  BACKUP
  OBSERVABILITY
  FIX_ATTEMPT
  VERIFY
  FIXED
  ROLLBACK
  ESCALATED
}

enum TriggerType {
  MANUAL
  AUTOMATIC
  WEBHOOK
  SCHEDULED
  EXTERNAL
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IntegrationType {
  WEBHOOK
  SLACK
  DISCORD
  EMAIL
  TEAMS
  PAGERDUTY
  CUSTOM
}

enum WebhookDeliveryStatus {
  PENDING
  DELIVERED
  FAILED
  RETRYING
}

// Indexes for performance
// These will be added as separate migration files