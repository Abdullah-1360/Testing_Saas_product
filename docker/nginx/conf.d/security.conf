# Enhanced Security Configuration for WP-AutoHealer
# This file contains advanced security settings for production deployment

# Security Headers
map $sent_http_content_type $csp_header {
    default "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data: https:; font-src 'self' https://cdnjs.cloudflare.com; connect-src 'self' wss: ws:; frame-ancestors 'none'; base-uri 'self'; form-action 'self';";
    ~*text/html "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data: https:; font-src 'self' https://cdnjs.cloudflare.com; connect-src 'self' wss: ws:; frame-ancestors 'none'; base-uri 'self'; form-action 'self';";
}

# Rate Limiting Zones
limit_req_zone $binary_remote_addr zone=global:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=auth:10m rate=1r/s;
limit_req_zone $binary_remote_addr zone=upload:10m rate=2r/s;

# Connection Limiting
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
limit_conn_zone $server_name zone=conn_limit_per_server:10m;

# DDoS Protection - Burst Control
map $request_method $limit {
    default         "";
    ~^(POST|PUT|DELETE)$ $binary_remote_addr;
}

limit_req_zone $limit zone=write_ops:10m rate=2r/s;

# Geo-blocking (example - customize based on your needs)
geo $blocked_country {
    default 0;
    # Add country codes to block if needed
    # CN 1;  # China
    # RU 1;  # Russia
}

# Bot Detection
map $http_user_agent $blocked_agent {
    default 0;
    ~*bot 0;  # Allow legitimate bots
    ~*crawl 0;
    ~*spider 0;
    ~*(nmap|nikto|sqlmap|dirb|dirbuster) 1;
    ~*(havij|libwww-perl|python|curl|wget) 1;
    "" 1;  # Block empty user agents
}

# Request Size Limits
client_max_body_size 10m;
client_body_buffer_size 128k;
client_header_buffer_size 3m;
large_client_header_buffers 4 256k;

# Timeout Configuration
client_body_timeout 10s;
client_header_timeout 10s;
keepalive_timeout 5s 5s;
send_timeout 10s;

# SSL Security Configuration
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;
ssl_session_tickets off;

# OCSP Stapling
ssl_stapling on;
ssl_stapling_verify on;
ssl_trusted_certificate /etc/nginx/ssl/cert.pem;

# Security Headers Function
map $sent_http_content_type $security_headers {
    default "X-Frame-Options: DENY; X-Content-Type-Options: nosniff; X-XSS-Protection: 1; mode=block; Referrer-Policy: strict-origin-when-cross-origin; Permissions-Policy: camera=(), microphone=(), geolocation=(), payment=()";
}

# Hide Nginx Version
server_tokens off;
# more_clear_headers Server;  # Requires headers-more module
# more_set_headers "Server: WP-AutoHealer";  # Requires headers-more module

# Request ID for tracking
map $request_id $req_id {
    ~^(?<p1>.{8})(?<p2>.{4})(?<p3>.{4})(?<p4>.{4})(?<p5>.{12})$ $p1-$p2-$p3-$p4-$p5;
}