# PostgreSQL Exporter Custom Queries for WP-AutoHealer
# These queries provide application-specific metrics

wp_autohealer_incidents:
  query: |
    SELECT 
      state,
      COUNT(*) as count
    FROM incidents 
    WHERE created_at > NOW() - INTERVAL '24 hours'
    GROUP BY state
  master: true
  metrics:
    - state:
        usage: "LABEL"
        description: "Incident state"
    - count:
        usage: "GAUGE"
        description: "Number of incidents in each state in the last 24 hours"

wp_autohealer_incident_processing_time:
  query: |
    SELECT 
      AVG(EXTRACT(EPOCH FROM (resolved_at - created_at))) as avg_processing_time_seconds,
      COUNT(*) as total_resolved
    FROM incidents 
    WHERE state = 'FIXED' 
      AND resolved_at IS NOT NULL 
      AND created_at > NOW() - INTERVAL '24 hours'
  master: true
  metrics:
    - avg_processing_time_seconds:
        usage: "GAUGE"
        description: "Average incident processing time in seconds"
    - total_resolved:
        usage: "GAUGE"
        description: "Total incidents resolved in the last 24 hours"

wp_autohealer_sites_health:
  query: |
    SELECT 
      CASE 
        WHEN last_health_check > NOW() - INTERVAL '1 hour' THEN 'healthy'
        WHEN last_health_check > NOW() - INTERVAL '6 hours' THEN 'stale'
        ELSE 'unhealthy'
      END as health_status,
      COUNT(*) as count
    FROM sites 
    WHERE is_active = true
    GROUP BY health_status
  master: true
  metrics:
    - health_status:
        usage: "LABEL"
        description: "Site health status"
    - count:
        usage: "GAUGE"
        description: "Number of sites in each health status"

wp_autohealer_audit_events:
  query: |
    SELECT 
      CASE 
        WHEN action LIKE 'ERROR_%' THEN 'error'
        WHEN action LIKE 'SECURITY_%' THEN 'security'
        WHEN action LIKE 'INCIDENT_%' THEN 'incident'
        ELSE 'other'
      END as event_type,
      COUNT(*) as count
    FROM audit_events 
    WHERE timestamp > NOW() - INTERVAL '1 hour'
    GROUP BY event_type
  master: true
  metrics:
    - event_type:
        usage: "LABEL"
        description: "Type of audit event"
    - count:
        usage: "GAUGE"
        description: "Number of audit events by type in the last hour"

wp_autohealer_user_sessions:
  query: |
    SELECT 
      COUNT(*) as active_sessions
    FROM user_sessions 
    WHERE expires_at > NOW()
  master: true
  metrics:
    - active_sessions:
        usage: "GAUGE"
        description: "Number of active user sessions"

wp_autohealer_retention_stats:
  query: |
    SELECT 
      table_name,
      records_purged,
      executed_at
    FROM purge_audit 
    WHERE executed_at > NOW() - INTERVAL '24 hours'
    ORDER BY executed_at DESC
    LIMIT 10
  master: true
  metrics:
    - table_name:
        usage: "LABEL"
        description: "Table name that was purged"
    - records_purged:
        usage: "GAUGE"
        description: "Number of records purged"
    - executed_at:
        usage: "GAUGE"
        description: "Timestamp when purge was executed"

wp_autohealer_database_size:
  query: |
    SELECT 
      schemaname,
      tablename,
      pg_total_relation_size(schemaname||'.'||tablename) as size_bytes
    FROM pg_tables 
    WHERE schemaname = 'public'
      AND tablename IN ('incidents', 'incident_events', 'command_executions', 'evidence', 'audit_events')
  master: true
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Schema name"
    - tablename:
        usage: "LABEL"
        description: "Table name"
    - size_bytes:
        usage: "GAUGE"
        description: "Table size in bytes"

wp_autohealer_connection_stats:
  query: |
    SELECT 
      state,
      COUNT(*) as connections
    FROM pg_stat_activity 
    WHERE datname = current_database()
    GROUP BY state
  master: true
  metrics:
    - state:
        usage: "LABEL"
        description: "Connection state"
    - connections:
        usage: "GAUGE"
        description: "Number of database connections by state"

wp_autohealer_slow_queries:
  query: |
    SELECT 
      COUNT(*) as slow_queries
    FROM pg_stat_activity 
    WHERE state = 'active' 
      AND query_start < NOW() - INTERVAL '30 seconds'
      AND datname = current_database()
  master: true
  metrics:
    - slow_queries:
        usage: "GAUGE"
        description: "Number of queries running longer than 30 seconds"

wp_autohealer_backup_artifacts:
  query: |
    SELECT 
      artifact_type,
      COUNT(*) as count,
      SUM(size) as total_size_bytes
    FROM backup_artifacts 
    WHERE created_at > NOW() - INTERVAL '24 hours'
    GROUP BY artifact_type
  master: true
  metrics:
    - artifact_type:
        usage: "LABEL"
        description: "Type of backup artifact"
    - count:
        usage: "GAUGE"
        description: "Number of backup artifacts created in the last 24 hours"
    - total_size_bytes:
        usage: "GAUGE"
        description: "Total size of backup artifacts in bytes"