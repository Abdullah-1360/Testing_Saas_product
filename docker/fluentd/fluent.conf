# Fluentd Configuration for WP-AutoHealer Security Monitoring
# Collects, processes, and forwards security events and application logs

<system>
  log_level info
  suppress_repeated_stacktrace true
  emit_error_log_interval 30s
  suppress_config_dump
  without_source
</system>

# Input Sources
<source>
  @type tail
  @id nginx_access_log
  path /var/log/nginx/access.log
  pos_file /var/log/fluentd/nginx_access.log.pos
  tag nginx.access
  format json
  time_key time_local
  time_format %d/%b/%Y:%H:%M:%S %z
  keep_time_key true
  read_from_head true
  refresh_interval 5
</source>

<source>
  @type tail
  @id nginx_security_log
  path /var/log/nginx/security.log
  pos_file /var/log/fluentd/nginx_security.log.pos
  tag nginx.security
  format /^(?<remote_addr>[^ ]*) - (?<remote_user>[^ ]*) \[(?<time_local>[^\]]*)\] "(?<request>[^"]*)" (?<status>[^ ]*) (?<body_bytes_sent>[^ ]*) "(?<http_referer>[^"]*)" "(?<http_user_agent>[^"]*)" suspicious=(?<suspicious_request>[^ ]*) blocked_agent=(?<blocked_agent>[^ ]*) blocked_country=(?<blocked_country>[^ ]*) request_id=(?<request_id>[^ ]*) upstream_response_time=(?<upstream_response_time>[^ ]*)$/
  time_key time_local
  time_format %d/%b/%Y:%H:%M:%S %z
  keep_time_key true
  read_from_head true
  refresh_interval 1
</source>

<source>
  @type tail
  @id nginx_error_log
  path /var/log/nginx/error.log
  pos_file /var/log/fluentd/nginx_error.log.pos
  tag nginx.error
  format /^(?<time_local>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?<log_level>\w+)\] (?<pid>\d+)#(?<tid>\d+): (?<message>.*)$/
  time_key time_local
  time_format %Y/%m/%d %H:%M:%S
  keep_time_key true
  read_from_head true
  refresh_interval 5
</source>

<source>
  @type tail
  @id app_log
  path /var/log/app/wp-autohealer.log
  pos_file /var/log/fluentd/app.log.pos
  tag app.main
  format json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%LZ
  keep_time_key true
  read_from_head true
  refresh_interval 5
</source>

<source>
  @type tail
  @id app_error_log
  path /var/log/app/wp-autohealer-error.log
  pos_file /var/log/fluentd/app_error.log.pos
  tag app.error
  format json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%LZ
  keep_time_key true
  read_from_head true
  refresh_interval 1
</source>

# Security Event Processing
<filter nginx.security>
  @type record_transformer
  <record>
    event_type security_incident
    severity high
    source nginx
    alert_required true
    timestamp ${time}
  </record>
</filter>

<filter nginx.error>
  @type record_transformer
  <record>
    event_type nginx_error
    severity ${record["log_level"] == "error" ? "high" : "medium"}
    source nginx
    alert_required ${record["log_level"] == "error" ? "true" : "false"}
    timestamp ${time}
  </record>
</filter>

<filter app.error>
  @type record_transformer
  <record>
    event_type application_error
    severity high
    source application
    alert_required true
    timestamp ${time}
  </record>
</filter>

# Rate Limiting Detection
<filter nginx.access>
  @type grep
  <regexp>
    key status
    pattern ^(429|503)$
  </regexp>
</filter>

<filter nginx.access>
  @type record_transformer
  <record>
    event_type rate_limit_triggered
    severity medium
    source nginx
    alert_required false
    timestamp ${time}
  </record>
</filter>

# DDoS Attack Detection
<filter nginx.**>
  @type numeric_counter
  @id ddos_detection
  count_interval 60s
  aggregate all
  tag ddos.detection
  count_key remote_addr
  threshold 1000
  comparator >=
</filter>

# Failed Authentication Detection
<filter app.main>
  @type grep
  <regexp>
    key message
    pattern (authentication failed|invalid credentials|login attempt failed)
  </regexp>
</filter>

<filter app.main>
  @type record_transformer
  <record>
    event_type auth_failure
    severity high
    source application
    alert_required true
    timestamp ${time}
  </record>
</filter>

# Output Configurations

# Security Alerts (High Priority)
<match nginx.security app.error>
  @type copy
  
  # Local file storage
  <store>
    @type file
    @id security_alerts_file
    path /var/log/fluentd/security_alerts
    time_slice_format %Y%m%d%H
    time_slice_wait 10m
    time_format %Y-%m-%dT%H:%M:%S.%LZ
    buffer_type file
    buffer_path /var/log/fluentd/security_alerts.*.buffer
    flush_interval 30s
    retry_limit 3
    retry_wait 10s
    max_retry_wait 30s
    format json
    include_time_key true
  </store>
  
  # Forward to external SIEM (if configured)
  <store>
    @type forward
    @id security_siem_forward
    require_ack_response true
    send_timeout 60s
    recover_wait 10s
    heartbeat_interval 1s
    phi_threshold 8
    hard_timeout 60s
    
    <server>
      name siem_server
      host ${ENV['SIEM_HOST'] || 'localhost'}
      port ${ENV['SIEM_PORT'] || 24224}
      weight 60
    </server>
    
    <buffer>
      @type file
      path /var/log/fluentd/siem_forward.*.buffer
      flush_mode interval
      flush_interval 10s
      chunk_limit_size 2m
      queue_limit_length 32
      retry_type exponential_backoff
      retry_wait 1s
      retry_max_interval 60s
      retry_timeout 60m
      overflow_action drop_oldest_chunk
    </buffer>
  </store>
</match>

# Application Logs
<match app.main>
  @type file
  @id app_logs_file
  path /var/log/fluentd/application
  time_slice_format %Y%m%d%H
  time_slice_wait 10m
  time_format %Y-%m-%dT%H:%M:%S.%LZ
  buffer_type file
  buffer_path /var/log/fluentd/application.*.buffer
  flush_interval 60s
  retry_limit 3
  retry_wait 10s
  max_retry_wait 30s
  format json
  include_time_key true
</match>

# Nginx Access Logs
<match nginx.access>
  @type file
  @id nginx_access_file
  path /var/log/fluentd/nginx_access
  time_slice_format %Y%m%d%H
  time_slice_wait 10m
  time_format %Y-%m-%dT%H:%M:%S.%LZ
  buffer_type file
  buffer_path /var/log/fluentd/nginx_access.*.buffer
  flush_interval 60s
  retry_limit 3
  retry_wait 10s
  max_retry_wait 30s
  format json
  include_time_key true
</match>

# DDoS Detection Alerts
<match ddos.detection>
  @type copy
  
  # Alert file
  <store>
    @type file
    @id ddos_alerts_file
    path /var/log/fluentd/ddos_alerts
    time_slice_format %Y%m%d%H
    time_slice_wait 5m
    time_format %Y-%m-%dT%H:%M:%S.%LZ
    buffer_type file
    buffer_path /var/log/fluentd/ddos_alerts.*.buffer
    flush_interval 10s
    retry_limit 3
    retry_wait 5s
    max_retry_wait 15s
    format json
    include_time_key true
  </store>
  
  # Immediate notification (webhook, email, etc.)
  <store>
    @type http
    @id ddos_webhook
    endpoint ${ENV['ALERT_WEBHOOK_URL'] || 'http://localhost:3000/api/v1/alerts/ddos'}
    http_method post
    headers {"Content-Type":"application/json", "Authorization":"Bearer ${ENV['ALERT_WEBHOOK_TOKEN']}"}
    format json
    <buffer>
      flush_mode immediate
      retry_type exponential_backoff
      retry_wait 1s
      retry_max_interval 30s
      retry_timeout 5m
    </buffer>
  </store>
</match>

# Catch-all for unmatched logs
<match **>
  @type file
  @id catch_all_logs
  path /var/log/fluentd/misc
  time_slice_format %Y%m%d
  time_slice_wait 10m
  time_format %Y-%m-%dT%H:%M:%S.%LZ
  buffer_type file
  buffer_path /var/log/fluentd/misc.*.buffer
  flush_interval 300s
  format json
  include_time_key true
</match>